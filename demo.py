#!/usr/bin/env python3
"""
RAGç³»ç»Ÿæ¼”ç¤ºè„šæœ¬
"""

import os
import sys
from rag_system import RAGSystem
from qa_system import QASystem

def create_sample_documents():
    """åˆ›å»ºç¤ºä¾‹æ–‡æ¡£"""
    sample_docs = {
        "ai_introduction.txt": """
äººå·¥æ™ºèƒ½ï¼ˆArtificial Intelligenceï¼ŒAIï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œå®ƒä¼å›¾äº†è§£æ™ºèƒ½çš„å®è´¨ï¼Œ
å¹¶ç”Ÿäº§å‡ºä¸€ç§æ–°çš„èƒ½ä»¥äººç±»æ™ºèƒ½ç›¸ä¼¼çš„æ–¹å¼åšå‡ºååº”çš„æ™ºèƒ½æœºå™¨ã€‚è¯¥é¢†åŸŸçš„ç ”ç©¶åŒ…æ‹¬æœºå™¨äººã€
è¯­è¨€è¯†åˆ«ã€å›¾åƒè¯†åˆ«ã€è‡ªç„¶è¯­è¨€å¤„ç†å’Œä¸“å®¶ç³»ç»Ÿç­‰ã€‚

äººå·¥æ™ºèƒ½ä»è¯ç”Ÿä»¥æ¥ï¼Œç†è®ºå’ŒæŠ€æœ¯æ—¥ç›Šæˆç†Ÿï¼Œåº”ç”¨é¢†åŸŸä¹Ÿä¸æ–­æ‰©å¤§ï¼Œå¯ä»¥è®¾æƒ³ï¼Œæœªæ¥äººå·¥æ™ºèƒ½
å¸¦æ¥çš„ç§‘æŠ€äº§å“ï¼Œå°†ä¼šæ˜¯äººç±»æ™ºæ…§çš„"å®¹å™¨"ã€‚äººå·¥æ™ºèƒ½å¯ä»¥å¯¹äººçš„æ„è¯†ã€æ€ç»´çš„ä¿¡æ¯è¿‡ç¨‹çš„æ¨¡æ‹Ÿã€‚
äººå·¥æ™ºèƒ½ä¸æ˜¯äººçš„æ™ºèƒ½ï¼Œä½†èƒ½åƒäººé‚£æ ·æ€è€ƒã€ä¹Ÿå¯èƒ½è¶…è¿‡äººçš„æ™ºèƒ½ã€‚

äººå·¥æ™ºèƒ½æ˜¯ä¸€é—¨æå¯ŒæŒ‘æˆ˜æ€§çš„ç§‘å­¦ï¼Œä»äº‹äººå·¥æ™ºèƒ½å·¥ä½œçš„äººå‘˜å¿…é¡»æ‡‚å¾—è®¡ç®—æœºçŸ¥è¯†ï¼Œå¿ƒç†å­¦å’Œå“²å­¦ã€‚
äººå·¥æ™ºèƒ½æ˜¯åŒ…æ‹¬ååˆ†å¹¿æ³›çš„ç§‘å­¦ï¼Œå®ƒç”±ä¸åŒçš„é¢†åŸŸç»„æˆï¼Œå¦‚æœºå™¨å­¦ä¹ ï¼Œè®¡ç®—æœºè§†è§‰ç­‰ç­‰ï¼Œæ€»çš„è¯´æ¥ï¼Œ
äººå·¥æ™ºèƒ½ç ”ç©¶çš„ä¸€ä¸ªä¸»è¦ç›®æ ‡æ˜¯ä½¿æœºå™¨èƒ½å¤Ÿèƒœä»»ä¸€äº›é€šå¸¸éœ€è¦äººç±»æ™ºèƒ½æ‰èƒ½å®Œæˆçš„å¤æ‚å·¥ä½œã€‚
        """,
        
        "machine_learning.txt": """
æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªå­é¢†åŸŸï¼Œå®ƒä½¿è®¡ç®—æœºèƒ½å¤Ÿåœ¨æ²¡æœ‰æ˜ç¡®ç¼–ç¨‹çš„æƒ…å†µä¸‹å­¦ä¹ å’Œæ”¹è¿›ã€‚
æœºå™¨å­¦ä¹ ç®—æ³•é€šè¿‡åˆ†ææ•°æ®æ¥è¯†åˆ«æ¨¡å¼ï¼Œå¹¶ä½¿ç”¨è¿™äº›æ¨¡å¼æ¥åšå‡ºé¢„æµ‹æˆ–å†³ç­–ã€‚

æœºå™¨å­¦ä¹ ä¸»è¦åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼š
1. ç›‘ç£å­¦ä¹ ï¼šä½¿ç”¨æ ‡è®°çš„è®­ç»ƒæ•°æ®æ¥å­¦ä¹ è¾“å…¥å’Œè¾“å‡ºä¹‹é—´çš„æ˜ å°„å…³ç³»
2. æ— ç›‘ç£å­¦ä¹ ï¼šä»æœªæ ‡è®°çš„æ•°æ®ä¸­å‘ç°éšè—çš„æ¨¡å¼å’Œç»“æ„
3. å¼ºåŒ–å­¦ä¹ ï¼šé€šè¿‡ä¸ç¯å¢ƒäº¤äº’æ¥å­¦ä¹ æœ€ä¼˜çš„è¡Œä¸ºç­–ç•¥

å¸¸è§çš„æœºå™¨å­¦ä¹ ç®—æ³•åŒ…æ‹¬ï¼š
- çº¿æ€§å›å½’
- å†³ç­–æ ‘
- éšæœºæ£®æ—
- æ”¯æŒå‘é‡æœº
- ç¥ç»ç½‘ç»œ
- æ·±åº¦å­¦ä¹ 

æœºå™¨å­¦ä¹ åœ¨å„ä¸ªé¢†åŸŸéƒ½æœ‰å¹¿æ³›åº”ç”¨ï¼ŒåŒ…æ‹¬ï¼š
- æ¨èç³»ç»Ÿ
- å›¾åƒè¯†åˆ«
- è‡ªç„¶è¯­è¨€å¤„ç†
- åŒ»ç–—è¯Šæ–­
- é‡‘èé¢„æµ‹
        """,
        
        "deep_learning.txt": """
æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œå®ƒåŸºäºäººå·¥ç¥ç»ç½‘ç»œï¼Œç‰¹åˆ«æ˜¯æ·±åº¦ç¥ç»ç½‘ç»œã€‚
æ·±åº¦å­¦ä¹ æ¨¡å‹å¯ä»¥è‡ªåŠ¨å­¦ä¹ æ•°æ®çš„å±‚æ¬¡åŒ–è¡¨ç¤ºï¼Œè¿™ä½¿å¾—å®ƒåœ¨å¤„ç†å¤æ‚æ¨¡å¼è¯†åˆ«ä»»åŠ¡æ—¶éå¸¸æœ‰æ•ˆã€‚

æ·±åº¦å­¦ä¹ çš„ä¸»è¦ç‰¹ç‚¹ï¼š
1. å¤šå±‚ç¥ç»ç½‘ç»œç»“æ„
2. è‡ªåŠ¨ç‰¹å¾æå–
3. ç«¯åˆ°ç«¯å­¦ä¹ 
4. éœ€è¦å¤§é‡æ•°æ®è®­ç»ƒ

å¸¸è§çš„æ·±åº¦å­¦ä¹ æ¶æ„ï¼š
- å·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰ï¼šä¸»è¦ç”¨äºå›¾åƒå¤„ç†
- å¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰ï¼šé€‚ç”¨äºåºåˆ—æ•°æ®
- é•¿çŸ­æœŸè®°å¿†ç½‘ç»œï¼ˆLSTMï¼‰ï¼šæ”¹è¿›çš„RNNï¼Œè§£å†³æ¢¯åº¦æ¶ˆå¤±é—®é¢˜
- å˜æ¢å™¨ï¼ˆTransformerï¼‰ï¼šåœ¨è‡ªç„¶è¯­è¨€å¤„ç†ä¸­è¡¨ç°å‡ºè‰²

æ·±åº¦å­¦ä¹ çš„åº”ç”¨é¢†åŸŸï¼š
- è®¡ç®—æœºè§†è§‰
- è¯­éŸ³è¯†åˆ«
- è‡ªç„¶è¯­è¨€å¤„ç†
- æ¸¸æˆAI
- è‡ªåŠ¨é©¾é©¶
        """
    }
    
    # åˆ›å»ºç¤ºä¾‹æ–‡æ¡£ç›®å½•
    if not os.path.exists("sample_docs"):
        os.makedirs("sample_docs")
    
    # å†™å…¥ç¤ºä¾‹æ–‡æ¡£
    for filename, content in sample_docs.items():
        filepath = os.path.join("sample_docs", filename)
        with open(filepath, "w", encoding="utf-8") as f:
            f.write(content.strip())
        print(f"åˆ›å»ºç¤ºä¾‹æ–‡æ¡£: {filename}")
    
    return list(sample_docs.keys())

def main():
    """ä¸»æ¼”ç¤ºå‡½æ•°"""
    print("ğŸ” RAGç³»ç»Ÿæ¼”ç¤º")
    print("=" * 50)
    
    # åˆ›å»ºç¤ºä¾‹æ–‡æ¡£
    print("\n1. åˆ›å»ºç¤ºä¾‹æ–‡æ¡£...")
    sample_files = create_sample_documents()
    sample_paths = [os.path.join("sample_docs", f) for f in sample_files]
    
    # åˆå§‹åŒ–RAGç³»ç»Ÿ
    print("\n2. åˆå§‹åŒ–RAGç³»ç»Ÿ...")
    rag_system = RAGSystem()
    qa_system = QASystem(rag_system)
    
    # æ·»åŠ æ–‡æ¡£
    print("\n3. æ·»åŠ æ–‡æ¡£åˆ°ç³»ç»Ÿ...")
    rag_system.add_documents(sample_paths)
    
    # æ„å»ºç´¢å¼•
    print("\n4. æ„å»ºå‘é‡ç´¢å¼•...")
    rag_system.build_index()
    
    # æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€
    print("\n5. ç³»ç»ŸçŠ¶æ€:")
    stats = rag_system.get_stats()
    for key, value in stats.items():
        print(f"   {key}: {value}")
    
    # æ¼”ç¤ºé—®ç­”
    print("\n6. æ¼”ç¤ºé—®ç­”åŠŸèƒ½:")
    demo_questions = [
        "ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ",
        "æœºå™¨å­¦ä¹ æœ‰å“ªäº›ç±»å‹ï¼Ÿ",
        "æ·±åº¦å­¦ä¹ çš„ä¸»è¦ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ",
        "ç¥ç»ç½‘ç»œåœ¨å“ªäº›é¢†åŸŸæœ‰åº”ç”¨ï¼Ÿ"
    ]
    
    for question in demo_questions:
        print(f"\né—®é¢˜: {question}")
        print("-" * 30)
        
        result = qa_system.get_answer_with_sources(question)
        
        if "error" in result:
            print(f"é”™è¯¯: {result['error']}")
        else:
            print(f"ç­”æ¡ˆ: {result['answer']}")
            print(f"ç½®ä¿¡åº¦: {result['confidence']:.3f}")
            print("æ¥æºæ–‡æ¡£:")
            for i, source in enumerate(result['sources'][:2], 1):
                print(f"  {i}. ç›¸ä¼¼åº¦: {source['score']:.3f}")
                print(f"     {source['content'][:100]}...")
    
    # äº¤äº’å¼é—®ç­”
    print("\n" + "=" * 50)
    print("ğŸ¯ äº¤äº’å¼é—®ç­”æ¨¡å¼")
    print("è¾“å…¥ 'quit' é€€å‡º")
    print("=" * 50)
    
    while True:
        try:
            question = input("\nè¯·è¾“å…¥æ‚¨çš„é—®é¢˜: ").strip()
            if question.lower() in ['quit', 'exit', 'q']:
                break
            
            if not question:
                continue
            
            print("æ­£åœ¨æ€è€ƒ...")
            result = qa_system.get_answer_with_sources(question)
            
            if "error" in result:
                print(f"âŒ {result['error']}")
            else:
                print(f"\nâœ… ç­”æ¡ˆ: {result['answer']}")
                print(f"ğŸ“Š ç½®ä¿¡åº¦: {result['confidence']:.3f}")
                
                if result['sources']:
                    print("\nğŸ“š ç›¸å…³æ–‡æ¡£:")
                    for i, source in enumerate(result['sources'][:3], 1):
                        print(f"  {i}. ç›¸ä¼¼åº¦: {source['score']:.3f}")
                        print(f"     {source['content'][:150]}...")
        
        except KeyboardInterrupt:
            print("\n\nğŸ‘‹ å†è§ï¼")
            break
        except Exception as e:
            print(f"âŒ å‘ç”Ÿé”™è¯¯: {e}")

if __name__ == "__main__":
    main() 